generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum ExpenseType {
  RENT
  ZESA
  WIFI
  OTHER
}

enum ExpenseStatus {
  PENDING
  PAID
  OVERDUE
}

enum DocumentType {
  INVOICE
  RECEIPT
  OTHER
}

enum AlertRuleType {
  DUE_REMINDER
  OVERDUE_ESCALATION
}

enum AlertSendStatus {
  SENT
  FAILED
  SKIPPED
  PENDING
}

enum UserRole {
  VIEWER
  FULL_ACCESS
}

model User {
  id           BigInt   @id @default(autoincrement())
  username     String   @unique @db.VarChar(80)
  passwordHash String   @db.VarChar(255)
  role         UserRole @default(VIEWER)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}
model Branch {
  id        BigInt   @id @default(autoincrement())
  city      String   @db.VarChar(80)
  label     String   @db.VarChar(80)
  address   String?  @db.VarChar(255)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  recipients BranchRecipient[]
  metrics    BranchMetric[]
  expenses   Expense[]

  @@unique([city, label])
  @@index([city])
  @@index([label])
}

model BranchRecipient {
  id        BigInt   @id @default(autoincrement())
  branchId  BigInt
  email     String   @db.VarChar(190)
  name      String?  @db.VarChar(120)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  branch Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  @@unique([branchId, email], name: "uq_branch_email")
  @@index([email])
}

model BranchMetric {
  id         BigInt   @id @default(autoincrement())
  branchId   BigInt
  metricDate DateTime @db.Date

  cashBalance   Decimal @default(0.00) @db.Decimal(18, 2)
  eFloatBalance Decimal @default(0.00) @db.Decimal(18, 2)
  cashInVault   Decimal @default(0.00) @db.Decimal(18, 2)
  cashInVolume  Int     @default(0) @db.UnsignedInt
  cashInValue   Decimal @default(0.00) @db.Decimal(18, 2)
  cashOutVolume Int     @default(0) @db.UnsignedInt
  cashOutValue  Decimal @default(0.00) @db.Decimal(18, 2)

  notes     String?  @db.VarChar(500)
  createdBy String?  @db.VarChar(120)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  branch    Branch     @relation(fields: [branchId], references: [id], onDelete: Cascade)
  documents Document[]

  @@unique([branchId, metricDate], name: "uq_branch_date")
  @@index([metricDate])
  @@index([branchId, metricDate])
}

model Expense {
  id       BigInt @id @default(autoincrement())
  branchId BigInt

  expenseType ExpenseType
  period      String        @db.Char(7) // YYYY-MM
  dueDate     DateTime      @db.Date
  amount      Decimal       @db.Decimal(18, 2)
  currency    String        @default("USD") @db.Char(3)
  status      ExpenseStatus @default(PENDING)

  vendor String? @db.VarChar(120)
  notes  String? @db.VarChar(500)

  createdBy String?  @db.VarChar(120)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  branch    Branch     @relation(fields: [branchId], references: [id], onDelete: Cascade)
  payments  Payment[]
  documents Document[]
  alertLogs AlertLog[]

  @@index([branchId, period])
  @@index([dueDate, status])
  @@index([status])
  @@index([expenseType])
  @@unique([branchId, expenseType, period])
}

model Payment {
  id        BigInt @id @default(autoincrement())
  expenseId BigInt

  paidDate   DateTime @db.Date
  amountPaid Decimal  @db.Decimal(18, 2)
  currency   String   @default("USD") @db.Char(3)
  reference  String?  @db.VarChar(120)
  notes      String?  @db.VarChar(300)

  createdBy String?  @db.VarChar(120)
  createdAt DateTime @default(now())

  expense   Expense    @relation(fields: [expenseId], references: [id], onDelete: Cascade)
  documents Document[]

  @@index([expenseId])
  @@index([paidDate])
}

model Document {
  id BigInt @id @default(autoincrement())

  docType  DocumentType
  fileName String       @db.VarChar(255)
  filePath String       @db.VarChar(500)
  mimeType String?      @db.VarChar(100)
  fileSize BigInt?

  // Attach to exactly ONE of these (enforced by app validation)
  expenseId BigInt?
  paymentId BigInt?
  metricId  BigInt?

  uploadedBy String?  @db.VarChar(120)
  uploadedAt DateTime @default(now())

  expense Expense?      @relation(fields: [expenseId], references: [id], onDelete: Cascade, map: "fk_document_expense")
  payment Payment?      @relation(fields: [paymentId], references: [id], onDelete: Cascade, map: "fk_document_payment")
  metric  BranchMetric? @relation(fields: [metricId], references: [id], onDelete: Cascade, map: "fk_document_metric")

  @@index([expenseId])
  @@index([paymentId])
  @@index([metricId])
  @@index([docType])
}

model AlertRule {
  id        BigInt        @id @default(autoincrement())
  ruleType  AlertRuleType
  dayOffset Int
  isActive  Boolean       @default(true)
  createdAt DateTime      @default(now())
  alertLogs AlertLog[]

  @@unique([ruleType, dayOffset], name: "uq_rule_type_offset")
}

model AlertLog {
  id           BigInt          @id @default(autoincrement())
  expenseId    BigInt
  ruleId       BigInt
  ruleType     AlertRuleType
  dayOffset    Int
  triggerLocalDate DateTime    @db.Date
  sentTo       String          @db.VarChar(190)
  sentAt       DateTime        @default(now())
  status       AlertSendStatus @default(SENT)
  errorMessage String?         @db.VarChar(500)

  expense Expense @relation(fields: [expenseId], references: [id], onDelete: Cascade)
  rule    AlertRule @relation(fields: [ruleId], references: [id], onDelete: Restrict)

  @@index([expenseId])
  @@index([ruleId])
  @@index([expenseId, ruleId, triggerLocalDate, status], name: "idx_alert_dedupe_lookup")
  @@index([sentAt])
}

model JobLock {
  jobName     String   @id @db.VarChar(100)
  lockedUntil DateTime
  lockedBy    String   @db.VarChar(100)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

